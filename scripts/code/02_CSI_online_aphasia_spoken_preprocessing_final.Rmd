---
title: "02 CSI online aphasia: Spoken - Preprocessing Final Data Set"
author: "Kirsten Stark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load packages

```{r load_packages}
rm(list = ls())

# install.packages("remotes") # uncomment if installation is needed (only once)
# remotes::install_github("rstudio/renv") # uncomment if installation is needed (only once)
# if file is accessed through the R package, all packages should be installed if 
# renv::restore()
# is applied. Otherwise use: 
# install.packages("tidyr") # uncomment if installation is needed (only once)
# install.packages("dplyr") # uncomment if installation is needed (only once)
# install.packages("here") # uncomment if installation is needed (only once)
# install.packages("knitr")

library(tidyr)
library(dplyr)

options( "encoding" = "UTF-8" )

# set working directory -- @ Marcus: Am besten, du klickst in dem Ordner, den ich dir als .zip-file geschickt habe, die Datei "CSI_online_aphasia.Rproj" an. Dann öffnet sich R Studio neu. In dem neuen Fenster unten links unter Files --> Scripts findest du dann dieses Skript hier mit dem Namen "02_CSI_online_aphasia_typing_preprocessing.Rmd"). Doppelklick darauf sollte das Skript öffnen. Dann brauchst du den Befehl hier unten nicht. Ansonsten auf den Experiment-Ordner auf deinene Computer anpassen. 
# setwd("/Users/kirstenstark/Documents/Research/CSI_online_aphasia")
```


# Load and preprocess data
This input file needs to be entered by hand: 

```{r specify input}
files <- list.files(here::here("data", "raw", "final"), 
                    recursive = TRUE)
sosci_files <- files[grep("data.csv", files, fixed=T)]
vot_files <- files[-grep("data.csv", files, fixed=T)]

# input output main data
type <- c("final_patients")
#input <- c("pilot_newdissmtukl_2021-10-13_10-44.csv")
#input <- c("data_dissmtukl_2021-08-12_22-27.csv") # can be a vector of several files
# possibly, the CSV file needs to be opened once and saved as CSV UTF-8 (durch Trennzeichen getrennte Datei)
# then all relevant rows of column A need to be selected (e.g. A1:3). Then click Daten --> Text in Spalten --> click through the options
# save again as CSV UTF-8
```


```{r load_data}
options( "encoding" = "UTF-8" )

# output
output <- c("aphasia_patient_final.csv") # data file for spoken data

# arrays
arrays <- "arrays_umlaut.csv"

# load SOSCISURVEY DATA
datafiles <- list()
for(i in 1:length(sosci_files)) {
   datafiles[[i]] <- read.csv(here::here("data", "raw", "final",
                                         sosci_files[i]), sep = ";", 
                              na = "")
} 
# if(type == "pilot_patient" || type == "main") {
#   datafiles[[i]]$QUESTNNR <- "online_CSI_spoken"
# }

# save cell instructions
instructions <- datafiles[[1]][1,]

# perform some transformations on each dataframe
for(i in 1:length(sosci_files)) {
  # add type column
  datafiles[[i]]$type <- type[i]
  # delete instruction column
  if(datafiles[[i]][1,1] == "Interview-Nummer (fortlaufend)") {
    datafiles[[i]] <- datafiles[[i]][-c(1),]
  }
  # add subject id: each subject is saved in a separate folder
  datafiles[[i]] <- datafiles[[i]] %>% dplyr::mutate(subject = i)
  # add testing session per subject
  datafiles[[i]] <- datafiles[[i]] %>% dplyr::mutate(session = row_number())
}

# load VOT DATA
datafiles_vot <- list()
for(i in 1:length(vot_files)) {
  if(i==23){
    datafiles_vot[[i]] <- read.csv(here::here("data", "raw",
                                             "final",
                                         vot_files[i]), 
                                  sep =";", 
                              na = "")
  } else {
   datafiles_vot[[i]] <- read.csv(here::here("data", "raw",
                                             "final",
                                         vot_files[i]), 
                                  sep =",", 
                              na = "")
  }
   datafiles_vot[[i]]$name <- vot_files[i]
} 


# perform some transformations on each dataframe
participant <- 1
#session <- 1
for(i in 1:length(vot_files)) {
  # add type column
  datafiles_vot[[i]]$type <- type[i]
  # add subject personal code 
  datafiles_vot[[i]]$OR02_01 <- substr(vot_files[i], 1,6)
  # add subject id: each subject is saved in a separate folder
  ## and add testing session per subject
  if (i == 1) {
    datafiles_vot[[i]] <- datafiles_vot[[i]] %>% dplyr::mutate(subject = participant)
    # datafiles_vot[[i]] <- datafiles_vot[[i]] %>% dplyr::mutate(session = session)
    # session <- session +1
  } else if (datafiles_vot[[i]]$OR02_01[1] == datafiles_vot[[i-1]]$OR02_01[1]){
     datafiles_vot[[i]] <- datafiles_vot[[i]] %>% 
       dplyr::mutate(subject = participant)
     # datafiles_vot[[i]] <- datafiles_vot[[i]] %>% 
     #   dplyr::mutate(session = session)
     # session <- session + 1
  } else if (datafiles_vot[[i]]$OR02_01[1] != datafiles_vot[[i-1]]$OR02_01[1]){
     participant <- participant +1
     # session <- 1
    datafiles_vot[[i]] <- datafiles_vot[[i]] %>% 
      dplyr::mutate(subject = participant)
    # datafiles_vot[[i]] <- datafiles_vot[[i]] %>% 
    #   dplyr::mutate(session = session)
    #  session <- session + 1
  } else {
    print("error")
  }
  
  # add session ID
  datafiles_vot[[i]] <- datafiles_vot[[i]] %>%
    mutate(session=stringr::str_sub(name, start = -16)) %>%
    mutate(session=stringr::str_sub(session, start = 1, end=1)) %>% 
    mutate(session=as.numeric(as.character(session)))
  
  # fix corrupted trial no
  colnames(datafiles_vot[[i]])[1] <- "trial"
}

```

# Convert to long format, prepare wide dataframe, and bind long and wide dataframes together
First convert all variables with values for each trial, then bind them together. In a next step bind them to the variables that only have one value per participant.

```{r prepare_long_df}
for(i in 1:length(sosci_files)){
  # print(i)

#-------------------------------------------------------------
# Prepare long data frame
    ## if the file also contains spoken data 
    if("online_CSI_spoken" %in% datafiles[[i]]$QUESTNNR){
      ### AUDIO FILES
      # In some of the datafiles, two columns seem to be missing and the order of the columns is corrupted - adjust this ( in the TeaP data only row 3 of participant1)
      for (j in nrow(datafiles[[i]])) {
        if (!grepl("AR01", datafiles[[i]]$AR01x02[j], fixed=TRUE)) {
          for (k in 407:20){
            datafiles[[i]][j,k] <- datafiles[[i]][j, k-1]
          }
          for (k in 407:38){
            datafiles[[i]][j,k] <- datafiles[[i]][j, k-1]
          }
        }
      }
      
      # Rename session like the audio files 
      datafiles[[i]]$session <- 
        stringr::str_sub(datafiles[[i]]$AR01x02, start = -11)
      
      # Audio files of first 1-80 trials
      df1 <- datafiles[[i]] %>% 
              select('subject', starts_with("AR")&contains("x")) %>% 
                      pivot_longer(
                        cols = -subject,
                         names_to = c("trial"), 
                        values_to = "audio") %>%
                        group_by(subject) 
                        # order by AR, but for each repetition separately
      df1$session <- stringr::str_sub(df1$audio, start = -11)
      df1 %>% 
        arrange(session, trial) %>% 
        mutate(trial = rep(seq(1,80),
                            times = length(unique(df1$session))))-> df1
      # Audio files of last 1-80 trials
      df2 <- datafiles[[i]] %>% 
              select('subject', starts_with("AU")&contains("x")) %>% 
                      pivot_longer(
                        cols = -subject,
                         names_to = c("trial"), 
                        values_to = "audio") %>%
                        group_by(subject) 
                        # order by AU, but for each repetition separately
      df2$session <- stringr::str_sub(df2$audio, start = -11)
      df2 %>% 
        arrange(session, trial) %>% 
        mutate(trial = rep(seq(81,160),
                            times = length(unique(df1$session))))-> df2
      # bind first 80 and last 80 trials together
      df_audio <- bind_rows(df1, df2) %>%
            arrange(subject, session, trial)
      # delete audiofile columns from wide data frame
      datafiles[[i]] <- datafiles[[i]] %>% 
          select(!starts_with(c("AR", "AU")))
    }

### Arrange order
    df_main <- df_audio %>% arrange(subject, session, trial)


#-------------------------------------------------------------
# Adapt wide data frame with info that is assessed only once

# for control reasons: calculate time sum by hand:
# sum dwell times for each page
datafiles[[i]] <- datafiles[[i]] %>% 
  mutate_at(vars(contains("TIME0")), as.numeric)
datafiles[[i]] <- datafiles[[i]] %>% rowwise() %>% 
  dplyr::mutate(timetotal = rowSums(across(starts_with("TIME0")), na.rm=TRUE)/60)

# delete columns with info we don't need
if("SD22_BVS" %in% colnames(datafiles[[i]])){
  datafiles[[i]] <- datafiles[[i]] %>% 
  select(-c(SERIAL, REF, MODE, SD22_PRV,SD22_BVS,LASTDATA, 
            SD19, SD19_01, SD19_02, SD19_03, MISSING, MISSREL))
} else {
  datafiles[[i]] <- datafiles[[i]] %>% 
  select(-c(SERIAL, REF, MODE, SD22_PRV,LASTDATA, 
            SD19, SD19_01, SD19_02, SD19_03, MISSING, MISSREL))
}


# delete columns that contain only NAs
datafiles[[i]]<- datafiles[[i]] %>% select_if(~sum(!is.na(.)) > 0)

# delete practice audio files
if("online_CSI_spoken" %in% datafiles[[i]]$QUESTNNR){
  datafiles[[i]]<- datafiles[[i]] %>% select(!starts_with("PA"))
}

# add comments column if participant left no comment
if(!("IM01_01" %in% colnames(datafiles[[i]]))){
  datafiles[[i]]$IM01_01 <- ""
}

# give columns more recognizable names
  datafiles[[i]] <- datafiles[[i]] %>% 
  dplyr::rename(gender = SD01, age = SD02_01,language = SD21, 
                     os_system = SD22_OS, browser_automatic = SD22_BNM,
                     system_format  = SD22_FmF,
                     handedness = SD27, 
                     comments = IM01_01, time_wo_outlier = TIME_SUM,
                     screen_width = SD22_ScW, screen_height = SD22_ScH,
                     questionnaire_width = SD22_QnW)


#-------------------------------------------------------------
# Bind long and wide data frame together
# Repeat each subjects' rows 160 times (no of trials)
datafiles[[i]] <- datafiles[[i]] %>% slice(rep(seq_len(n()), 160))

# Add trial number to wide data frame
datafiles[[i]]$trial <- 
  rep(1:160, times = length(unique(datafiles[[i]]$session)))

# Arrange by session and trial
datafiles[[i]] %>% arrange(subject, session, trial) -> datafiles[[i]]

# bind wide and long info together
datafiles[[i]] <- datafiles[[i]] %>% 
  left_join(df_main, by = c("subject", "session", "trial")) %>%
  relocate(subject, session, trial)

# make sure sessions are ordered in the correct order: 
datafiles[[i]] %>% arrange(STARTED) -> datafiles[[i]]

# rename sessions in numerical order
datafiles[[i]] %>% mutate(session=case_when(
  STARTED == unique(datafiles[[i]]$STARTED)[1] ~ 1,
  STARTED == unique(datafiles[[i]]$STARTED)[2] ~ 2,  
  STARTED == unique(datafiles[[i]]$STARTED)[3] ~ 3))-> datafiles[[i]]

# prepare for merging
datafiles[[i]] <- datafiles[[i]] %>% select(-CASE)
datafiles[[i]] <- datafiles[[i]] %>% 
 #  mutate(CASE = as.character(CASE))%>% 
   mutate(OR01_01 = as.numeric(as.character(OR01_01))) %>% 
   mutate(gender = as.numeric(as.character(gender))) %>% 
   mutate(age = as.numeric(as.character(age))) %>% 
  mutate(language = as.numeric(as.character(language))) %>% 
  mutate(os_system = as.numeric(as.character(os_system))) %>% 
  mutate(system_format = as.numeric(as.character(system_format))) %>% 
  mutate(handedness = as.numeric(as.character(handedness))) %>% 
  mutate(comments = as.character(comments)) %>% 
  mutate(time_wo_outlier = as.numeric(as.character(time_wo_outlier))) %>% 
  mutate(screen_width = as.numeric(as.character(screen_width))) %>%
  mutate(screen_height = as.numeric(as.character(screen_height))) %>% 
  mutate(questionnaire_width = as.numeric(as.character(questionnaire_width)))%>% 
  mutate(browser_automatic = as.numeric(as.character(browser_automatic))) %>% 
  mutate(CH01 = as.numeric(as.character(CH01))) %>%
   mutate(CH01_01 = as.numeric(as.character(CH01_01))) %>%
   mutate(CH01_02 = as.numeric(as.character(CH01_02))) %>%
   mutate(CH01_03 = as.numeric(as.character(CH01_03))) %>%
    mutate(CH01_04 = as.numeric(as.character(CH01_04))) %>%
  mutate(CH02 = as.numeric(as.character(CH02))) %>%
   mutate(CH02_01 = as.numeric(as.character(CH02_01))) %>%
   mutate(CH02_02 = as.numeric(as.character(CH02_02))) %>%
   mutate(CH02_03 = as.numeric(as.character(CH02_03))) %>%
    mutate(CH02_04 = as.numeric(as.character(CH02_04))) %>%
  mutate(CH03 = as.numeric(as.character(CH03))) %>%
mutate(MC01 = as.numeric(as.character(MC01))) %>%
   mutate(MC01_01 = as.numeric(as.character(MC01_01))) %>%
   mutate(MC01_02 = as.numeric(as.character(MC01_02))) %>%
   mutate(MC01_03 = as.numeric(as.character(MC01_03))) %>%
    mutate(MC01_04 = as.numeric(as.character(MC01_04))) %>%
  mutate(MC02 = as.numeric(as.character(MC02))) %>%
  mutate(MC03 = as.numeric(as.character(MC03))) %>%
  mutate(FINISHED = as.numeric(as.character(FINISHED))) %>%
  mutate(Q_VIEWER = as.numeric(as.character(Q_VIEWER))) %>% 
  mutate(LASTPAGE = as.numeric(as.character(LASTPAGE))) %>%
  mutate(MAXPAGE = as.numeric(as.character(MAXPAGE))) %>%
  mutate(DEG_TIME = as.numeric(as.character(DEG_TIME)))


#-------------------------------------------------------------
# Convert numeric variables from string to integer:
#str(df)
# if(type[i] == "pilot_patient"){
#   datafiles[[i]] <-  datafiles[[i]] %>% 
#   mutate_at(vars(!c("type", contains("KB0"))), as.numeric)
# }else if(type[i] == "main") {
#   datafiles[[i]] <-  datafiles[[i]] %>% 
#   mutate_at(vars(!c( "browser_other", 
#                     "word", "comments", "type",
#                     "array_no", "TIME_RSI", contains("KB0"))), as.numeric)
# } else if(type[i] == "replacement") {
#     datafiles[[i]] <- datafiles[[i]] %>% 
#    mutate_at(vars(!c("operator_system_other", 
#                      "word", "comments", "type", 
#                     "array_no", contains("KB0"))), as.numeric)
# }
}
```


# Add array (actual stimuli) for each participant
For the spoken data, this is just to double check that everything went fine upon merging the files and to add the categories.

```{r add_arrays, warning = FALSE  }
# load arrays
arrays <- read.csv2(here::here("data", "supplementary_info", arrays), 
    sep = ";", na = "NA")

for (i in 1:length(sosci_files)) {
  # convert array column in datafiles
  # datafiles[[i]]$array <- as.numeric(
  #   stringr::str_remove(
  #   datafiles[[i]]$array, "Array"))
  datafiles[[i]]$array <-
    as.numeric(as.character(datafiles[[i]]$OR01_01))
  # bind arrays to data frame
  datafiles[[i]]$item <- NA
    for(j in 1:nlevels(as.factor(datafiles[[i]]$session))){
      array <- arrays[, unique(datafiles[[i]]$array[
                        datafiles[[i]]$session == j])]
      datafiles[[i]]$item[datafiles[[i]]$session == j] <- array
    }

  # add category columns
  datafiles[[i]] <- datafiles[[i]] %>% 
    group_by(subject, session, item) %>% 
    dplyr::mutate(
      category = arrays$categorie[arrays$item == item]) %>%
    dplyr::mutate(supercategory = 
                    arrays$supercategorie[arrays$item == item] )
  
    #   # add position number
    # datafiles[[i]] <- datafiles[[i]] %>% group_by(subject, category) %>% 
    #   add_count() %>% 
    #   dplyr::mutate(PosOr = seq(1:n)) %>% select(-n)
    # # add ordinal position for fillers
    # table(datafiles[[i]]$PosOr)
    # count <- 1
    # for (j in 1:nrow(datafiles[[i]])) {
    #   if(datafiles[[i]]$category [j] == "Filler") {
    #     datafiles[[i]]$PosOr[j] <- count
    #     count <- count+1
    #   }
    #   if(count == 6) {  count <- 1}
    # }
    # table(datafiles[[i]]$PosOr)
}

```

# Bind the dataframes together

```{r bind_input_dataframes_into_one}
df <- bind_rows(datafiles)

#  subject 7 = Patient 16 (id1967) in Session 1 drei Trials sowohl im SoSci-File fehlen: 
# 	Kirsche.AU18.000046.webm,
# 	Biene.AU19.000046.webm, 
# 	Bein.AU30.000046.webm
# subject 14 = Ebenso fehlt bei Patient 24 in Session 3 ein Trial in beiden Files: 
# 	Birne.AU50.00021.web
# --> Fix these erroneous trials

for(i in 1:nrow(df)){
  if(!startsWith(tolower(df$audio[i]), df$item[i]) &
     !is.na(df$audio[i])){
    for(j in 160:df$trial[i+1]){
    if(j-1 != 0){
      df$audio[df$subject==df$subject[i] & 
                 df$session==df$session[i] &
                 df$trial==j] <- 
        df$audio[df$subject==df$subject[i] & 
                 df$session==df$session[i] &
                 df$trial==j-1]
    }
    if(j==df$trial[[i+1]]){
      df$audio[df$subject==df$subject[i] & 
                 df$session==df$session[i] &
                 df$trial==j-1] <- NA
    }
    }
  }}

# Did it the array merging work now? 
x <- strsplit(df$audio, "[.]")
sum_error = 0
for (i in 1:nrow(df)){
  if(df$item[i] != tolower(x[[i]][1]) & !is.na(x[[i]][i]) &
     !is.na(df$item[i])){
    print("merging error")
    print(df$item[i])
    print(x[[i]])
    print(df$subject[i])
    print(df$session[i])
    print(df$trial[i])
    sum_error = sum_error+1
  }
}
```



# Combine data frame with audio files

```{r}
# fix participant ID
for(i in 1:length(datafiles_vot)) {
  if(i <= length(datafiles)) {
     datafiles[[i]] <- datafiles[[i]] %>%
       mutate(OR02_01=toupper(OR02_01))
  }
  datafiles_vot[[i]] <- datafiles_vot[[i]] %>%
    mutate(group=toupper(OR02_01))
  for(j in 1:nrow(datafiles_vot[[i]])){
    datafiles_vot[[i]]$OR02_01<- strsplit(strsplit(
      datafiles_vot[[i]]$name, "/")[[j]][3], "_")[[1]][1]
    datafiles_vot[[i]]$session <- strsplit(strsplit(
      datafiles_vot[[i]]$name, "/")[[j]][3], "_")[[1]][2]
  }
  # fix filename
  datafiles_vot[[i]] <- datafiles_vot[[i]] %>% rename(audio=File_name)
}

# bind VOT files of one participant into one data frame
data_vot <- as.data.frame(datafiles_vot[[1]])
## file 23 has one additional column --> delete
datafiles_vot[[23]] <- datafiles_vot[[23]] %>% select(-X)
for(i in 2:length(vot_files)) {
  data_vot <- rbind(data_vot, datafiles_vot[[i]])
}

# add item to data_vot
x <- strsplit(data_vot$audio, "[.]")
for(i in 1:nrow(data_vot)) {
  data_vot$item[i] <- tolower(x[[i]][1])
}

data_vot$item[data_vot$item == "loewenzahn"] <- "löwenzahn"
data_vot$item[data_vot$item == "wuerfel"] <- "würfel"
data_vot$item[data_vot$item == "muelleimer"] <- "mülleimer"
data_vot$item[data_vot$item == "buerste"] <- "bürste"
data_vot$item[data_vot$item == "saege"] <- "säge"
data_vot$item[data_vot$item == "schluessel"] <- "schlüssel" 
data_vot$item[data_vot$item == "kopfhoerer"] <- "kopfhörer"
data_vot$item[data_vot$item == "geschirrspueler"] <- "geschirrspüler"
data_vot$item[data_vot$item == "uboot"] <- "u-boot"
data_vot$item[data_vot$item == "kuehlschrank"] <- "kühlschrank"
data_vot$item[data_vot$item == "kaefig"] <- "käfig" 
data_vot$item[data_vot$item == "marienkaefer"] <- "marienkäfer"
data_vot$item[data_vot$item == "loewe"] <- "löwe" 
data_vot$item[data_vot$item == "loeffel"] <- "löffel"  
data_vot$item[data_vot$item == "faecher"] <-  "fächer"
data_vot$item[data_vot$item == "baer"] <- "bär"  

## delete practice items
data_vot <- data_vot %>% filter(grepl(".PA", .$audio)!=TRUE)
data_vot <- data_vot %>% filter(!is.na(audio))

# merge data from data_vot with df
df$VOT <- NA
df$correct <- NA
df$AR <- NA
df$error <- NA
df$name <- NA
df$audio_vot <- NA
df$filename <- NA

for(i in 1:nrow(df)) {
  # n <- strsplit(df$audio[i], "[.]")
  # m <- paste0(n[[1]][2],".", n[[1]][3], ".wav", sep="")
  # x <- data_vot[endsWith(data_vot$audio,m),]  %>%
  #   filter(!is.na(audio))
  x <- data_vot[tolower(data_vot$OR02_01) ==
                  tolower(df$OR02_01)[i] &
           data_vot$session == df$session[i] &
           data_vot$item == df$item[i],] %>% filter(!is.na(audio))
  
  if(nrow(x) != 0){
      if(!is.na(x$VOT)){df$VOT[i] <- x$VOT}
      if(!is.na(x$correct)){df$correct[i] <- x$correct}
      if(!is.na(x$AR)){df$AR[i] <- x$AR}
      if(!is.na(x$error)){df$error[i] <- x$error}
      if(!is.na(x$name)){df$filename[i] <- x$name}
      if(!is.na(x$audio)){df$audio_vot[i] <- x$audio}
  }
}

# for(i in 1:nrow(data_vot)) {
#   x <- df[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i],]
#   df$VOT[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i]] <- data_vot$VOT[i]
#   df$correct[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i]] <- data_vot$correct[i]
#   df$AR[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i]] <- data_vot$AR[i]
#   df$error[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i]] <- data_vot$error[i]
#   df$filename[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i]] <- data_vot$name[i]
#   df$audio_vot[tolower(df$OR02_01) == tolower(data_vot$OR02_01)[i] &
#            df$session == data_vot$session[i] & 
#            df$item == data_vot$item[i]] <- data_vot$audio[i]
# }

# check the differences: just file names once written wit Umlaut, once without. The numbering also differs, but the item name is correct
x <- df[stringr::str_sub(df$audio, end = -5) !=
          stringr::str_sub(df$audio_vot, end = -4),]
x <- x %>% select(audio, audio_vot) %>% 
  filter(!startsWith(audio,"Säge")) %>% 
           filter(!startsWith(audio,"Käfig")) %>% 
           filter(!startsWith(audio,"Bürste")) %>% 
           filter(!startsWith(audio,"Löwenzahn")) %>% 
           filter(!startsWith(audio,"U-Boot")) %>% 
           filter(!startsWith(audio,"Geschirrspüler")) %>% 
           filter(!startsWith(audio,"Kühlschrank")) %>% 
           filter(!startsWith(audio,"Kopfhörer")) %>% 
           filter(!startsWith(audio,"Marienkäfer")) %>% 
           filter(!startsWith(audio,"Schlüssel")) %>% 
           filter(!startsWith(audio,"Fächer")) %>% 
           filter(!startsWith(audio,"Mülleimer")) %>% 
           filter(!startsWith(audio,"Würfel")) %>% 
           filter(!startsWith(audio,"Löwe")) %>% 
           filter(!startsWith(audio,"Löffel")) %>% 
           filter(!startsWith(audio,"Bär"))%>% 
           droplevels()
x <- x %>% filter(
    strsplit(audio, "[.]")[[1]][1] != 
      strsplit(audio_vot, "[.]")[[1]][1]) %>%
         droplevels()

sum(is.na(df$VOT)) # 160 audio files missing (session 3 of aw1975)
x <- df[is.na(df$VOT),]
```



# Roughly check participants' adherence to the experiment
**Did all participants finish the experiment?**

```{r prolific_check}
# did all participants finish the experiment?
for(i in 1:length(unique(df$subject))) {
  print(paste(i,":"))
  print("Experiment completed?")
  print(table(df$FINISHED[df$subject==i])/160)
  print("What was the last experimental page reached?")
  print(table(df$LASTPAGE[df$subject==i])/160)
}
```

Participant 17 in one session only reached the second last page.  
Participant 1 still had a previous version of the experiment, with two more pages in sessions 1 and 2.


# Export prepared data frame
Anonmyse data frame

```{r}
#colnames(df)
#sum(df$OR01_01 != df$array)
df <- df %>% select(-c("QUESTNNR", "STARTED", "OR01_01", "OR02_01",
                 "filename", "audio", "audio_vot")) %>%
  # drop unnecessary columns
  select(-c("os_system", "SD22_BID", "browser_automatic",
            "system_format", "screen_width", "screen_height",
            "questionnaire_width", starts_with("TIME0"), 
            "FINISHED", "Q_VIEWER", 
            "LASTPAGE", "MAXPAGE", "DEG_TIME"))
                
```


```{r export_data}
#if("online_CSI_spoken" %in% unique(df$QUESTNNR)) {
  write.csv(df, here::here("data", "transient_data_files", output), 
            row.names = FALSE)
#}
```
