---
title: "Power Analysis for CSI online typing with patients with aphasia - Summary"
author: "Kirsten Stark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packages

```{r message=FALSE}
library(tidyr)
library(dplyr)
library(devtools)
library(MASS)
library(lme4)
library(lmerTest)
library(simr)
library(pbkrtest)
library(testthat)
library(ggplot2)

rm(list = ls())

today <- Sys.Date()
today <- format(today, format="%d%m%y")

# Set number of iterations 
n_iter = 1000
set.seed(99)
```


# Load data from Lorenz, Doering, van Scherpenberg, Pino, Abdel Rahman, & Obrig (2021)

In this lab-based study, people with Aphasia did a CSI task with 3 repetitions in two subsequent weeks. Both testing sessions had different items. Additionally, participants also did a CSI task with compounds (not relevant here).  
The data loaded here are already cleaned for errors and participants.

```{r load data Lorenz_et_al}
# load data
df <- read.csv2(here::here("data", "power-analysis",
                "Doeringetal_PWA_naming_simple_nouns_data_for_modelling.csv"))

# subset the relevant columns
df <- df %>% 
  filter(error==1) %>% 
    # repet_trig = repetition (151,152,153 is 1,2,3), 
    # wh = testing session 1 and 2, 
    # cat_nr = 18 categories (Ã  5 members each)
  dplyr::select(c(subject, Ordinal_position, RT, 
                  repet_trig, wh, item_id, cat_nr)) %>%
  droplevels() %>% 
  dplyr::rename(repet = repet_trig, 
                OrdPos = Ordinal_position) %>% 
  # factorize colums
  mutate(subject = as.factor(subject),
         repet = as.factor(repet), 
         wh = as.factor(wh), 
         item_id = as.factor(item_id),
         cat_nr = as.factor(cat_nr))
```

The data structure is somewhat different from the planned experiment. Our experiment will have no repetition, but three testing sessions with the same items. Still, the variances between repetitions and sessions is somewhat comparable. Therefore, we will run our power analyses based on the variance estimates from the three repetitions. An additional analysis with the factor session (two levels) has also been run. 


# Comparison 1: Power analysis for the ordinal position effect in the first repetition only

Subset the data to the first session and first repetition 

```{r}
df_Ord <- df %>% filter(wh == 1, repet == 151) %>% droplevels()
```

## 1) Set up models based on the structure of the online CSI experiment
Unfortunately, simr does not work properly with GLMMs. Therefore, for the power analysis, we will set up an LMM with transformed RTs  
a) center OrdPos (continuous predictor)

```{r}
# center continuous predictor
df_Ord %>% mutate(OrdPos_num = case_when(OrdPos == "OP1" ~1,
                                         OrdPos == "OP2" ~2,
                                         OrdPos == "OP3" ~3,
                                         OrdPos == "OP4" ~4,
                                         OrdPos == "OP5" ~5)) %>%
                  mutate(OrdPos.c=
                    scale(as.numeric(as.character(OrdPos_num)), 
                     center = TRUE, scale = FALSE)) -> df_Ord
```

b) Check distribution of RTs: An inverse transformation (1000/x) is needed and appropriate

```{r RT distributions}
# Boxcox plot suggests inverse transformation: 
boxcox(df_Ord$RT ~ df_Ord$OrdPos)

# apply transformation
df_Ord$iRT <-1000/df_Ord$RT
plot(df_Ord$RT, df_Ord$iRT)

# check fit
fit.normal_inv<- fitdistrplus::fitdist(df_Ord$iRT, distr = "norm", method = "mle")
summary(fit.normal_inv)
plot(fit.normal_inv)
```

c) Set up the model 
*Model 1: Linear model with continuous predictor "Ordinal position" as the only predictor and inversely transformed RT data*

```{r LMM1 online}
lmm1 <- lmer(iRT ~ OrdPos.c + 
               (OrdPos.c|subject) +(OrdPos.c|cat_nr) ,
            data = df_Ord, REML = FALSE,
            control=lmerControl(optimizer = "bobyqa"))
isSingular(lmm1)
summary(lmm1)
```

## 2) Extend dataset

We already know that we want 24 categories (we use the same stimuli as in Stark, van Scherpenberg et al., 2021). So we extend along categories.  
Additionally, we also reduce along participants: Our power curve suggested that 16 participants would be sufficient to achieve a power of .80 based on the effect size from Lorenz et al., 2016. 

```{r}
lmm1_2 <- extend(lmm1, along="cat_nr", n=24)
# m2data <- getData(lmm1_2) 
# ## ok, data were indeed extended to n categories ;-)
# str(m2data)
# str(df_Ord)
```

## 3) Specify effect size and run power analysis
We use the experimental effect size from Lorenz et al  

*Linear model with continuous predictor "Ordinal position" and inversely transformed RT data* 

```{r PowerSim_LMM1_Lorenz1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM_OrdPos_Lorenz <- powerCurve(lmm1_2, along = "subject", breaks=16, test=fixed("OrdPos.c","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM_OrdPos_Lorenz
```

## 5) Use effect from Stark, van Scherpenberg et al., 2021
Our effect size from a neurotypical sample in an online experiment was smaller. We we take this effect on 16 participants + 25 % (=20 participants), the power is substantially reduced. 

*Extend to 20 participants*

```{r}
lmm24_20_Stark <- extend(lmm1_2, along="subject", n=20)
#str(lmm24_20_Stark)
```

*Specify effect size*  
What effect size is 31 ms in 1/(RT/1000) depends on the position: We take the grand mean 

```{r}
# calculate the effect size in the transformed scale
gm <- mean(df_Ord$RT)
eff1 <- 1000/(gm+(31/2)) - 1000/(gm-(31/2))

# use this as the fixed effect of interest
fixef(lmm24_20_Stark)["OrdPos.c"] <- eff1
```

*Power analysis: Linear model with continuous predictor "Ordinal position" (effect size from Stark et al., 2021) and inversely transformed RT data* 

```{r power_eff_OrdPos_Stark1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM_OrdPos_Stark <- 
  powerSim(lmm24_20_Stark, test=fixed("OrdPos.c","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
```

```{r}
PowerLMM_OrdPos_Stark
```

Unfortunately, if the effect was that small and the variance estimates realistic, the power would be too low to reliably detect the effect. A power curve suggests that the power would still be below 80 % with 60 participants. Thus, this seems to be a risk that we need to take. Moreover, our main interest is the analyis across the three sessions.


# --------------------------------------------
# Comparison 2: Power analysis for the ordinal position effect across all three sessions (Ordinal position and interaction effect)
As a proxy for our sessions, we will use the variances from the three repetitions of the first session in Lorenz et al (2021)

Subset the data to the first session 

```{r}
df_full <- df %>% filter(wh == 1) %>% droplevels()
```

## 1) Set up models based on the structure of the new experiment
Unfortunately, simr does not work properly with GLMMs. Therefore, for the power analysis, we will set up an LMM with transformed RTs  
a) center OrdPos (continuous predictor)

```{r}
# center continuous predictor
df_full %>% mutate(OrdPos_num = case_when(OrdPos == "OP1" ~1,
                                         OrdPos == "OP2" ~2,
                                         OrdPos == "OP3" ~3,
                                         OrdPos == "OP4" ~4,
                                         OrdPos == "OP5" ~5)) %>%
                  mutate(OrdPos.c=
                    scale(as.numeric(as.character(OrdPos_num)), 
                     center = TRUE, scale = FALSE)) -> df_full
```

b) Check distribution of RTs: An inverse transformation (1000/x) is needed and appropriate

```{r RT distributions2}
# Boxcox plot suggests inverse transformation: 
boxcox(df_full$RT ~ df_full$OrdPos)

# apply transformation
df_full$iRT <-1000/df_full$RT
plot(df_full$RT, df_full$iRT)

# check fit
fit.normal_inv<- fitdistrplus::fitdist(df_full$iRT, distr = "norm", method = "mle")
summary(fit.normal_inv)
plot(fit.normal_inv)
```

c) Set up the model 
*Linear model with continuous predictor "Ordinal position" and fatcor "repet" (sliding difference contrast) as the predictor variables and inversely transformed RT data*

```{r LMM_full}
# compute sliding difference contrast: Intercept is grand mean, second level is compared to first level
contrasts(df_full$repet) <- contr.sdif(3)
# maximal model has singular fit - stepwise reduction
# lmm1 <- lmer(iRT ~ OrdPos.c*repet +
#               (OrdPos.c*repet|subject) +(OrdPos.c*repet|cat_nr) ,
#            data = df_full, REML = FALSE,
#            control=lmerControl(optimizer = "bobyqa"))

lmm1 <- afex::lmer_alt(iRT ~ OrdPos.c*repet +
               (repet||subject) +(OrdPos.c||cat_nr) ,
            data = df_full, REML = FALSE,
            control=lmerControl(optimizer = "bobyqa",
                                optCtrl=list(maxfun=2e5)))
isSingular(lmm1)
summary(lmm1)
```

## 2) Extend dataset

We already know that we want 24 categories (we use the same stimuli as in Stark, van Scherpenberg et al., 2021). So we extend along categories.  
Additionally, we also reduce along participants: Our power curve suggested that 16 participants would be sufficient to achieve a power of .80 based on the effect size from Lorenz et al., 2016. 

```{r}
lmm1_2 <- extend(lmm1, along="cat_nr", n=24)
# m2data <- getData(lmm1_2) 
# ## ok, data were indeed extended to n categories ;-)
# str(m2data)
# str(df_full)
```

## 3) Specify effect size and run power analysis
We use the experimental effect size from Lorenz et al to see the power if all effects remained the same

*Linear model with continuous predictor "Ordinal position", sliding difference contrasted predictor repetition and inversely transformed RT data* 

```{r PowerSim_LMM1_Lorenz, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM_OrdPos_Lorenz <- powerCurve(lmm1_2, along = "subject", breaks=16, test=fixed("OrdPos.c","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM_OrdPos_Lorenz
```

## 5) Use effect from Stark, van Scherpenberg et al., 2021
Our effect size from a neurotypical sample in an online experiment was smaller. We take this effect on 16 participants + 25 % (=20 participants), the power is substantially reduced. 

*Extend to 20 participants*

```{r}
lmm24_20_Stark <- extend(lmm1_2, along="subject", n=20)
#str(lmm24_20_Stark)
```

*Specifiy effect size*  
What effect size is 31 ms in 1/(RT/1000) depends on the position: We take the grand mean 

```{r}
# calculate the effect size in the transformed scale
gm <- mean(df_Ord$RT)
eff1 <- 1000/(gm+(31/2)) - 1000/(gm-(31/2))

# use this as the fixed effect of interest
fixef(lmm24_20_Stark)["OrdPos.c"] <- eff1
```

*Power analysis: Linear model with continuous predictor "Ordinal position" (effect size from Stark et al., 2021) and inversely transformed RT data* 

```{r power_eff_OrdPos_Stark, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM_OrdPos_Stark <- 
  powerSim(lmm24_20_Stark, test=fixed("OrdPos.c","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
```

```{r}
PowerLMM_OrdPos_Stark
```

Now, the power is high even with the more conservative effect size estimate. 

## 6) Estimate the effect size of the interaction effect of the ordinal position x Session we can reliably detect with our 20 VP - with oridnal position effect from Lorenz et al (2021)

## Extend data set

```{r}
lmm1_2 <- extend(lmm1, along="cat_nr", n=24)
lmm24_20 <- extend(lmm1, along="subject", n=20)
```

### Specify effect sizes and run different power analyses
To specify the effect sizes, we always take the grand mean and take +- 1/2 the inversely transformed difference we want to implement. 
We keep the two main effects unchanged. 

#### 40 ms interaction effect, 20 VP

```{r}
gm <- mean(df_Ord$RT)
eff_40ms <- (1000/(gm+(40/2))) - (1000/(gm-(40/2)))
fixef(lmm24_20_Stark)["OrdPos.c:repet2-1"]<- eff_40ms
fixef(lmm24_20_Stark)["OrdPos.c:repet3-2"]<- eff_40ms
```

*Model B2: Linear model with interaction effect "Ordinal position x Session" of 40 ms and ordinal position effect from Stark et al., 2021* 

```{r PowerSim_Interaction40_20_Stark_2-1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction24_20_Stark <- powerSim(lmm24_20_Stark, test=fixed("OrdPos.c:repet2-1","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction24_20_Stark
```


```{r PowerSim_Interaction40_20_Stark_3-2, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction24_20_Stark <- powerSim(lmm24_20_Stark, test=fixed("OrdPos.c:repet3-2","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction24_20_Stark
```


#### 45 ms interaction effect, 20 VP

```{r}
gm <- mean(df_Ord$RT)
eff_45ms <- (1000/(gm+(45/2))) - (1000/(gm-(45/2)))
fixef(lmm24_20_Stark)["OrdPos.c:repet2-1"]<- eff_45ms
fixef(lmm24_20_Stark)["OrdPos.c:repet3-2"]<- eff_45ms
```

*Model B3: Linear model with interaction effect "Ordinal position x Session" of 50 ms* 

```{r PowerSim_Interaction45_20_2-1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction45_20 <- powerSim(lmm24_20, test=fixed("OrdPos.c:repet2-1","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction45_20
```

```{r PowerSim_Interaction45_20_3-2, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction45_20 <- powerSim(lmm24_20, test=fixed("OrdPos.c:repet3-2","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction45_20
```

*Model B4: Linear model with interaction effect "Ordinal position x Session" of 45 ms and ordinal position effect from Stark et al., 2021* 

```{r PowerSim_Interaction45_20_Stark_2-1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction45_20_Stark <- powerSim(lmm24_20_Stark, test=fixed("OrdPos.c:repet2-1","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction45_20_Stark
```


```{r PowerSim_Interaction45_20_Stark_3-2, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction45_20_Stark <- powerSim(lmm24_20_Stark, test=fixed("OrdPos.c:repet3-2","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction45_20_Stark
```


#### 50 ms interaction effect, 20 VP

```{r}
gm <- mean(df_Ord$RT)
eff_50ms <- (1000/(gm+(50/2))) - (1000/(gm-(50/2)))
fixef(lmm24_20)["OrdPos.c:repet2-1"]<- eff_50ms
fixef(lmm24_20)["OrdPos.c:repet3-2"]<- eff_50ms
```

*Model B2: Linear model with interaction effect "Ordinal position x Session" of 50 ms* 

```{r PowerSim_Interaction50_20_2-1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction50_20 <- powerSim(lmm24_20, test=fixed("OrdPos.c:repet2-1","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction50_20
```


```{r PowerSim_Interaction50_20_3-2, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction50_20 <- powerSim(lmm24_20, test=fixed("OrdPos.c:repet3-2","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction50_20
```


#### 55 ms interaction effect, 20 VP

```{r}
gm <- mean(df_Ord$RT)
eff_55ms <- (1000/(gm+(55/2))) - (1000/(gm-(55/2)))
fixef(lmm24_20)["OrdPos.c:repet2-1"]<- eff_55ms
fixef(lmm24_20)["OrdPos.c:repet3-2"]<- eff_55ms
```

*Model B2: Linear model with interaction effect "Ordinal position x Session" of 55 ms* 

```{r PowerSim_Interaction55_20_2-1, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction55_20 <- powerSim(lmm24_20, test=fixed("OrdPos.c:repet2-1","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction55_20
```


```{r PowerSim_Interaction55_20_3-2, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM1_Interaction55_20 <- powerSim(lmm24_20, test=fixed("OrdPos.c:repet3-2","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM1_Interaction55_20
```

### What effect size does this mean?

Use the method by Westfall, Judd, and Kenny (2014), as reviewed in Brysbaert & Stevens (2018)  
Westfall d = (difference between the means)/sqrt(variances of all random effects)  
We use the experimental variances and the simulated effect sizes

```{r}
x <- summary(lmm1)
randomvars <-  0.0457486+0.0011736+0.0006358+0.0138004+0.0001398+0.0922992

(d_40 <- eff_40ms /sqrt(randomvars))
(d_45 <- eff_45ms /sqrt(randomvars))
(d_50 <- eff_50ms /sqrt(randomvars))
(d_55 <- eff_45ms /sqrt(randomvars))
```


## 7) Power for the Ordinal position effect if the effect of the interaction effect was 45 ms and 20 VP

```{r}
gm <- mean(df_Ord$RT)
eff_45ms <- (1000/(gm+(45/2))) - (1000/(gm-(45/2)))
fixef(lmm24_20)["OrdPos.c:repet2-1"]<- eff_45ms
fixef(lmm24_20)["OrdPos.c:repet3-2"]<- eff_45ms

eff1 <- 1000/(gm+(31/2)) - 1000/(gm-(31/2))
fixef(lmm24_20_Stark)["OrdPos.c"] <- eff1
fixef(lmm24_20_Stark)["OrdPos.c:repet2-1"]<- eff_45ms
fixef(lmm24_20_Stark)["OrdPos.c:repet3-2"]<- eff_45ms
```

*Linear model with continuous predictor "Ordinal position" and factor "Session" and inversely transformed RT data - Ordinal position effect from Lorenz et al* 

```{r PowerSim_LMM_Lorenz, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM_OrdPos_Lorenz <- powerSim(lmm24_20, test=fixed("OrdPos.c","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
``` 

```{r}
PowerLMM_OrdPos_Lorenz
```

*Linear model with continuous predictor "Ordinal position" and factor "Session" and inversely transformed RT data - Ordinal position effect from Stark et al*

```{r power_eff_OrdPos_Inter_Stark, message=FALSE, warning=FALSE, cache=TRUE, results="hide"}
PowerLMM_OrdPos_Stark <- 
  powerSim(lmm24_20_Stark, test=fixed("OrdPos.c","t"), nsim = n_iter) # increase to nsim > 1000 for real test
lastResult()$warnings
lastResult()$errors
```

```{r}
PowerLMM_OrdPos_Stark
```
